/*******************************************************************************
 *
 * Copyright 2020 Samsung Electronics All Rights Reserved.
 *
 * * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied. See the License for the specific
 * language governing permissions and limitations under the License.
 *
 ******************************************************************************/
#include <stdint.h>
#include <stddef.h>
#include <stdlib.h>
#include "ecg_api.h"
#include "bp6a/s1sbp6a_type.h"
#include "bp6a/s1sbp6a_ecg.h"
#include "bp6a/s1sbp6a_adc.h"
#include "bp6a/s1sbp6a_dma.h"
#include "bp6a/s1sbp6a_adc_fifo.h"
#include "bp6a/s1sbp6a_afe.h"
#include "arm_math.h"

#define ECG_DMA_R_POWER 3
#define ECG_FIFO_CH ADC_FIFO_SARADC_ID1
#define ECG_ADC_CH SARADC_CH0
#define ECG_SAMPLING_CLK 1024
#define ECG_LPF_COEF_LEN 129
#define ECG_LPF_WINDOW_SIZE 128

#define ECG_DATA_SIZE   (sizeof(uint16_t))

static dma_ch_t ecg_dma_ch;
static ecg_callback_t usr_cb = NULL;
static uint16_t *ECG_buffer;
static uint32_t g_data_size;
static ecg_decimation_rate_t deci_rate = ECG_DECIMATION_4;
static float32_t lpf_state[ECG_LPF_WINDOW_SIZE + ECG_LPF_COEF_LEN - 1];
arm_fir_instance_f32 lpf;
float32_t *p_lpf_coff = NULL;
float32_t *p_lpf_in_buf = NULL;
float32_t *p_lpf_out_buf = NULL;

const float32_t lpf_coff_1k[ECG_LPF_COEF_LEN] = {
    -7.772815949987e-07, -3.110311806251e-07, 4.945886208238e-07, 2.196918697067e-06,
    5.110155129972e-06, 9.476247947839e-06, 1.536979548276e-05, 2.258801379484e-05,
    3.053964239631e-05, 3.815224502607e-05, 4.382160063333e-05, 4.54286264146e-05,
    4.044748299921e-05, 2.616239974572e-05, -6.400487503497e-20, -4.003120348025e-05,
    -9.482091212666e-05, -0.0001636035103852, -0.000243436780091, -0.0003287940593495,
    -0.0004113594879423, -0.0004801146919995, -0.0005217920437679, -0.0005217433876142,
    -0.0004652342147045, -0.0003391237665227, -0.0001338352908778, 0.0001545368848478,
    0.0005221889861105, 0.0009558831845915, 0.001431801579079, 0.001915237564307,
    0.002361347497362, 0.002717118511621, 0.002924612137541, 0.002925423710762,
    0.00266616350218, 0.002104629143008, 0.001216214262778, -1.338456703642e-18,
    -0.00151608199356, -0.003271632914048, -0.005172281974075, -0.007090745406589,
    -0.008870730847592, -0.01033375124837, -0.01128866411559, -0.01154349319135,
    -0.01091884425973, -0.009262019002447, -0.006460783513449, -0.002455679968679,
    0.002750206435692, 0.009084993184382, 0.01640601458358, 0.02450256912257,
    0.03310351631544, 0.04188946118702, 0.05050888895087, 0.05859727254152,
    0.0657979028013, 0.07178301154801, 0.07627369002946, 0.0790571582887,
    0.08000011285501, 0.0790571582887, 0.07627369002946, 0.07178301154801,
    0.0657979028013, 0.05859727254152, 0.05050888895087, 0.04188946118702,
    0.03310351631544, 0.02450256912257, 0.01640601458358, 0.009084993184382,
    0.002750206435692, -0.002455679968679, -0.006460783513449, -0.009262019002447,
    -0.01091884425973, -0.01154349319135, -0.01128866411559, -0.01033375124837,
    -0.008870730847592, -0.007090745406589, -0.005172281974075, -0.003271632914048,
    -0.00151608199356, -1.338456703642e-18, 0.001216214262778, 0.002104629143008,
    0.00266616350218, 0.002925423710762, 0.002924612137541, 0.002717118511621,
    0.002361347497362, 0.001915237564307, 0.001431801579079, 0.0009558831845915,
    0.0005221889861105, 0.0001545368848478, -0.0001338352908778, -0.0003391237665227,
    -0.0004652342147045, -0.0005217433876142, -0.0005217920437679, -0.0004801146919995,
    -0.0004113594879423, -0.0003287940593495, -0.000243436780091, -0.0001636035103852,
    -9.482091212666e-05, -4.003120348025e-05, -6.400487503497e-20, 2.616239974572e-05,
    4.044748299921e-05, 4.54286264146e-05, 4.382160063333e-05, 3.815224502607e-05,
    3.053964239631e-05, 2.258801379484e-05, 1.536979548276e-05, 9.476247947839e-06,
    5.110155129972e-06, 2.196918697067e-06, 4.945886208238e-07, -3.110311806251e-07,
    -7.772815949987e-07};

const float32_t lpf_coff_512[ECG_LPF_COEF_LEN] = {
    -2.585797248481e-21, -1.169834091832e-06, -3.281136324034e-06, -5.939131211376e-06,
    -8.032130617413e-06, -7.802160902529e-06, -3.313891269974e-06, 6.6751905328e-06,
    2.163748573279e-05, 3.838827977007e-05, 5.090389798331e-05, 5.129932505894e-05,
    3.212966101966e-05, -1.031149170982e-05, -7.259073551823e-05, -0.0001419614259408,
    -0.0001968244790175, -0.0002107750062093, -0.0001601821164101, -3.388595124666e-05,
    0.0001577317145874, 0.0003778260282825, 0.0005655953533184, 0.0006479801835511,
    0.000559677671283, 0.0002674161131999, -0.0002083244028453, -0.0007822120521172,
    -0.001310533981369, -0.001618414854971, -0.001545073446352, -0.0009978003771184,
    1.47198121927e-18, 0.001283373295225, 0.002556868257301, 0.003448111834899,
    0.003598311887081, 0.002771463341469, 0.0009540864100368, -0.001586308346411,
    -0.004310717711878, -0.006498668910497, -0.007410590425795, -0.006491814821162,
    -0.003569379743453, 0.001014887435286, 0.006384737254213, 0.01125126894673,
    0.01417087220615, 0.01389686421012, 0.009750556216553, 0.001920470180798,
    -0.008397281795855, -0.01907722516734, -0.02737526706325, -0.03043101190054,
    -0.02586982975405, -0.01237913777101, 0.009873278464, 0.0390867598516,
    0.07199730848169, 0.1043571128505, 0.1316424999413, 0.149854456712,
    0.1562502266705, 0.149854456712, 0.1316424999413, 0.1043571128505,
    0.07199730848169, 0.0390867598516, 0.009873278464, -0.01237913777101,
    -0.02586982975405, -0.03043101190054, -0.02737526706325, -0.01907722516734,
    -0.008397281795855, 0.001920470180798, 0.009750556216553, 0.01389686421012,
    0.01417087220615, 0.01125126894673, 0.006384737254213, 0.001014887435286,
    -0.003569379743453, -0.006491814821162, -0.007410590425795, -0.006498668910497,
    -0.004310717711878, -0.001586308346411, 0.0009540864100368, 0.002771463341469,
    0.003598311887081, 0.003448111834899, 0.002556868257301, 0.001283373295225,
    1.47198121927e-18, -0.0009978003771184, -0.001545073446352, -0.001618414854971,
    -0.001310533981369, -0.0007822120521172, -0.0002083244028453, 0.0002674161131999,
    0.000559677671283, 0.0006479801835511, 0.0005655953533184, 0.0003778260282825,
    0.0001577317145874, -3.388595124666e-05, -0.0001601821164101, -0.0002107750062093,
    -0.0001968244790175, -0.0001419614259408, -7.259073551823e-05, -1.031149170982e-05,
    3.212966101966e-05, 5.129932505894e-05, 5.090389798331e-05, 3.838827977007e-05,
    2.163748573279e-05, 6.6751905328e-06, -3.313891269974e-06, -7.802160902529e-06,
    -8.032130617413e-06, -5.939131211376e-06, -3.281136324034e-06, -1.169834091832e-06,
    -2.585797248481e-21};

const float32_t lpf_coff_256[ECG_LPF_COEF_LEN] = {
    -5.171597645055e-21, -2.063404378744e-06, -3.645805563527e-06, -1.164274023488e-06,
    6.147530369922e-06, 1.20623112156e-05, 6.500435513888e-06, -1.277552591588e-05,
    -3.060004440605e-05, -2.228707237357e-05, 1.986172778926e-05, 6.508793421984e-05,
    5.936790854404e-05, -2.052369061098e-05, -0.0001207140549181, -0.0001338403873597,
    1.060822367014e-18, 0.0001987174212278, 0.0002663732866073, 6.744560331485e-05,
    -0.0002914503828843, -0.0004793808816615, -0.0002206844935561, 0.0003761976659006,
    0.000791504235096, 0.0005118028418398, -0.0004086432644714, -0.00120931692221,
    -0.001003039895021, 0.0003172649850301, 0.001716794674304, 0.001759963811649,
    -2.943964230611e-18, -0.00226366977627, -0.002841041516438, -0.000675948534655,
    0.00275403036379, 0.004284742876374, 0.001871508953632, -0.003036006731278,
    -0.006096279162671, -0.00377293031122, 0.002891470705113, 0.008236732463083,
    0.006595357792247, -0.002020002179406, -0.01061743648195, -0.01060762939043,
    8.677161926218e-18, 0.013101880857, 0.01621459226449, 0.003822447510748,
    -0.01551616300495, -0.02420494178749, -0.0106813058353, 0.01766732369073,
    0.03658548636505, 0.02369220693142, -0.01936714416294, -0.06042898469151,
    -0.05510438780519, 0.02045758400239, 0.146273397776, 0.264319824762,
    0.3125006435687, 0.264319824762, 0.146273397776, 0.02045758400239,
    -0.05510438780519, -0.06042898469151, -0.01936714416294, 0.02369220693142,
    0.03658548636505, 0.01766732369073, -0.0106813058353, -0.02420494178749,
    -0.01551616300495, 0.003822447510748, 0.01621459226449, 0.013101880857,
    8.677161926218e-18, -0.01060762939043, -0.01061743648195, -0.002020002179406,
    0.006595357792247, 0.008236732463083, 0.002891470705113, -0.00377293031122,
    -0.006096279162671, -0.003036006731278, 0.001871508953632, 0.004284742876374,
    0.00275403036379, -0.000675948534655, -0.002841041516438, -0.00226366977627,
    -2.943964230611e-18, 0.001759963811649, 0.001716794674304, 0.0003172649850301,
    -0.001003039895021, -0.00120931692221, -0.0004086432644714, 0.0005118028418398,
    0.000791504235096, 0.0003761976659006, -0.0002206844935561, -0.0004793808816615,
    -0.0002914503828843, 6.744560331485e-05, 0.0002663732866073, 0.0001987174212278,
    1.060822367014e-18, -0.0001338403873597, -0.0001207140549181, -2.052369061098e-05,
    5.936790854404e-05, 6.508793421984e-05, 1.986172778926e-05, -2.228707237357e-05,
    -3.060004440605e-05, -1.277552591588e-05, 6.500435513888e-06, 1.20623112156e-05,
    6.147530369922e-06, -1.164274023488e-06, -3.645805563527e-06, -2.063404378744e-06,
    -5.171597645055e-21};

const float32_t lpf_coff_128[ECG_LPF_COEF_LEN] = {
    -1.034318320432e-20, -2.292729424018e-06, 2.790375513077e-06, 2.283802980609e-06,
    -8.693910665593e-06, 4.706474859205e-06, 1.201122461252e-05, -2.124489833626e-05,
    2.398727785717e-19, 3.706200354545e-05, -3.669964468685e-05, -2.539602241791e-05,
    8.395880332862e-05, -4.025862026025e-05, -9.239042978529e-05, 0.000148715296615,
    -2.121642254933e-18, -0.0002208027100298, 0.0002038730489971, 0.0001322991553295,
    -0.0004121726026188, 0.0001870449225854, 0.000407771297006, -0.0006255931238387,
    -3.887046486062e-19, 0.000851096026472, -0.000755073414, -0.0004718515041985,
    0.001418510965639, -0.0006223369274221, -0.001313976221904, 0.001955564724852,
    -5.88792158131e-18, -0.002515252151144, 0.002174436497221, 0.001325919196891,
    -0.003894782540688, 0.001671821781528, 0.003458093593636, -0.005048688780321,
    3.285697912323e-17, 0.006274146475022, -0.005342734963747, -0.003213809821898,
    0.009327233539823, -0.003962372177939, -0.008126224576342, 0.01178655249212,
    -1.73543035743e-17, -0.01455801299071, 0.01241009714341, 0.007497991746066,
    -0.0219431425175, 0.009444288739954, 0.01973645662181, -0.02937965122961,
    2.240212320969e-17, 0.03939865418722, -0.03578577437574, -0.02357819261453,
    0.07792928152165, -0.04012894763449, -0.1119526810349, 0.2936961100918,
    0.6250005568374, 0.2936961100918, -0.1119526810349, -0.04012894763449,
    0.07792928152165, -0.02357819261453, -0.03578577437574, 0.03939865418722,
    2.240212320969e-17, -0.02937965122961, 0.01973645662181, 0.009444288739954,
    -0.0219431425175, 0.007497991746066, 0.01241009714341, -0.01455801299071,
    -1.73543035743e-17, 0.01178655249212, -0.008126224576342, -0.003962372177939,
    0.009327233539823, -0.003213809821898, -0.005342734963747, 0.006274146475022,
    3.285697912323e-17, -0.005048688780321, 0.003458093593636, 0.001671821781528,
    -0.003894782540688, 0.001325919196891, 0.002174436497221, -0.002515252151144,
    -5.88792158131e-18, 0.001955564724852, -0.001313976221904, -0.0006223369274221,
    0.001418510965639, -0.0004718515041985, -0.000755073414, 0.000851096026472,
    -3.887046486062e-19, -0.0006255931238387, 0.000407771297006, 0.0001870449225854,
    -0.0004121726026188, 0.0001322991553295, 0.0002038730489971, -0.0002208027100298,
    -2.121642254933e-18, 0.000148715296615, -9.239042978529e-05, -4.025862026025e-05,
    8.395880332862e-05, -2.539602241791e-05, -3.669964468685e-05, 3.706200354545e-05,
    2.398727785717e-19, -2.124489833626e-05, 1.201122461252e-05, 4.706474859205e-06,
    -8.693910665593e-06, 2.283802980609e-06, 2.790375513077e-06, -2.292729424018e-06,
    -1.034318320432e-20};

void uint16_to_float(uint16_t *in, uint32_t len, float *out)
{
    int i;

    for (i = 0; i < len; i++)
    {
        out[i] = (float)(in[i]);
    }
}

void ecg_apply_lpf(uint16_t *pdata, uint32_t len)
{

    int i;
    int j;

    uint16_to_float(pdata, len, p_lpf_in_buf);

    for (i = 0; i < len / ECG_LPF_WINDOW_SIZE; i++)
    {

        arm_fir_f32(&lpf, &p_lpf_in_buf[i * ECG_LPF_WINDOW_SIZE], &p_lpf_out_buf[i * ECG_LPF_WINDOW_SIZE], ECG_LPF_WINDOW_SIZE);

        for (j = 0; j < ECG_LPF_WINDOW_SIZE; j++)
        {
            pdata[j + i * ECG_LPF_WINDOW_SIZE] = (unsigned short)(p_lpf_out_buf[j + i * ECG_LPF_WINDOW_SIZE] + 0.5f);
        }
    }
}

static void ecg_dma_callback(dma_ch_t ch)
{
    uint32_t len = 0;
    uint32_t buf_sel = 0;

    if (usr_cb)
    {
        buf_sel = bp6a_dma_get_ch_conf_set(ch);

        if (buf_sel) {
            len = g_data_size;
        }

        if (!p_lpf_coff) {
            ecg_apply_lpf(&ECG_buffer[len], g_data_size);
        }

        usr_cb(&ECG_buffer[len], g_data_size);
    }
}

static int ecg_dma_set_config(dma_ch_t ch, uint32_t dma_size)
{
    DMA_cfg_desc_t prim;
    DMA_cfg_desc_t alt;

    uint32_t *ecg_fifo_addr = bp6a_adc_fifo_get_address(ECG_FIFO_CH);

    prim.srcAddr = ecg_fifo_addr;
    prim.dstAddr = (uint32_t *)&ECG_buffer[0];
    prim.dstInc = 1;
    prim.srcInc = 3;
    prim.dstsize = 1;
    prim.srcsize = 1;
    prim.r_pwr = ECG_DMA_R_POWER;
    prim.cycle_ctr = DMA_CYCLE_PING_PONG;
    prim.nMinus1 = dma_size;

    alt.srcAddr = ecg_fifo_addr;
    alt.dstAddr = (uint32_t *)&ECG_buffer[dma_size];
    alt.dstInc = 1;
    alt.srcInc = 3;
    alt.dstsize = 1;
    alt.srcsize = 1;
    alt.r_pwr = ECG_DMA_R_POWER;
    alt.cycle_ctr = DMA_CYCLE_PING_PONG;
    alt.nMinus1 = dma_size;

    return bp6a_dma_open(ch, &prim, &alt);
}

static void ecg_set_downsamping_rate(ecg_decimation_rate_t rate)
{
    bp6a_saradc_set_OSR(ECG_ADC_CH, (saradc_osr_mode_t)rate);
}

static uint32_t ecg_get_sampling_rate(void)
{
    uint32_t downsamping_rate = bp6a_saradc_get_OSR(ECG_ADC_CH);

    downsamping_rate = (uint32_t)0x01 << downsamping_rate;

    return (uint32_t)(ECG_SAMPLING_CLK / downsamping_rate);
}

static uint32_t ecg_get_data_size_per_sec(void)
{
    return (ecg_get_sampling_rate() * sizeof(uint16_t));
}

uint32_t ecg_buff_alloc(ecg_decimation_rate_t rate, uint16_t **buf)
{
    uint32_t len = 0;

    ecg_set_downsamping_rate(rate);

    len = ecg_get_data_size_per_sec() * 2;

    *buf = (uint16_t *)malloc(len);

    memset(*buf, 0xff, len);

    if (*buf == NULL)
    {
        return 0;
    }

    return len / ECG_DATA_SIZE;
}

void ecg_buff_free(uint16_t *buf)
{
    free(buf);
}

int ecg_set_callback(ecg_callback_t cb)
{
    if (usr_cb != NULL)
        return -1;

    usr_cb = cb;

    return 0;
}

int ecg_set_decimation_rate(ecg_decimation_rate_t rate)
{
    if (rate < ECG_NO_DECIMATION || rate > ECG_DECIMATION_16)
        return -1;

    deci_rate = rate;

    uint32_t len = ecg_buff_alloc(deci_rate, &ECG_buffer);

    if (!len)
    {
        return -1;
    }
    g_data_size = len / 2;

    return 0;
}

int ecg_lpf_init(void)
{

    switch (deci_rate)
    {
    case ECG_NO_DECIMATION:
        p_lpf_coff = lpf_coff_1k;
        break;
    case ECG_DECIMATION_2:
        p_lpf_coff = lpf_coff_512;
        break;
    case ECG_DECIMATION_4:
        p_lpf_coff = lpf_coff_256;
        break;
    case ECG_DECIMATION_8:
        p_lpf_coff = lpf_coff_128;
        break;
    default:
        p_lpf_coff = NULL;
        break;
    }

    if (!p_lpf_coff)
        return -1;

    arm_fir_init_f32(&lpf, ECG_LPF_COEF_LEN, (float32_t *)p_lpf_coff, lpf_state, ECG_LPF_WINDOW_SIZE);

    p_lpf_in_buf = (float32_t *)malloc(g_data_size * sizeof(float32_t));
    if (!p_lpf_in_buf)
        return -1;

    p_lpf_out_buf = (float32_t *)malloc(g_data_size * sizeof(float32_t));
    if (!p_lpf_out_buf) {
        free(p_lpf_in_buf);
        return -1;
    }

    return 0;
}

int ecg_init(void)
{
    bp6a_dma_init();

    bp6a_ecg_init(ECG_PGA_GAIN_X1_0);
    bp6a_saradc_init(ECG_ADC_CH);

    adc_fifo_config_t stFifoConfigEntry;

    stFifoConfigEntry.mode = ADC_FIFO_MODE_DMA;
    stFifoConfigEntry.mask = ADC_FIFO_INTMASK_NONE;
    stFifoConfigEntry.readySize = ADC_FIFO_READY_SIZE_08;

    if (bp6a_adc_fifo_open(ECG_FIFO_CH, &stFifoConfigEntry, NULL))
        return -1;

    return 0;
}

int ecg_start(void)
{
    ecg_dma_ch = bp6a_get_dma_ch(DMA_PERI_TYPE_AFE_FIFO, (uint32_t)ECG_FIFO_CH);

    if (ecg_dma_set_config(ecg_dma_ch, g_data_size))
    {
        return -1;
    }

    ecg_lpf_init();

    bp6a_dma_set_callback(ecg_dma_ch, ecg_dma_callback);

    if (bp6a_dma_start(ecg_dma_ch))
    {
        return -1;
    }

    if (bp6a_adc_fifo_start(ECG_FIFO_CH))
    {
        return -1;
    }

    return 0;
}

int ecg_stop(void)
{
    if (bp6a_adc_fifo_stop(ECG_FIFO_CH))
    {
        return -1;
    }

    if (bp6a_dma_stop(ecg_dma_ch))
    {
        return -1;
    }

    return 0;
}

int ecg_close(void)
{
    bp6a_ecg_deinit();
    if (bp6a_adc_fifo_close(ECG_FIFO_CH))
    {
        return -1;
    }

    if (bp6a_dma_close(ecg_dma_ch))
    {
        return -1;
    }

    usr_cb = NULL;
    ecg_buff_free(ECG_buffer);
    free(p_lpf_in_buf);
    free(p_lpf_out_buf);
    p_lpf_coff = NULL;

    return 0;
}
